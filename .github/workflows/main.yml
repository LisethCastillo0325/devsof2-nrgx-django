name: CI/CD APP

on:
  push:
    branches: 
      - "main"
      - "42-github-actions-test"

env:
  REGISTRY: zethoc
  IMAGE_NAME: devsof2-nrgx-backend

jobs:
  # test:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v2

  #   - name: Run Tests
  #     run: docker-compose -f local-db.yml run --rm django pytest

  # build-and-push-docker-image:
  #   runs-on: ubuntu-latest
  #   needs: test
  #   steps:
  #     -
  #       name: Set up QEMU
  #       uses: docker/setup-qemu-action@v2
  #     -
  #       name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v2
  #     -
  #       name: Login to Docker Hub
  #       uses: docker/login-action@v2
  #       with:
  #         username: ${{ secrets.DOCKERHUB_USERNAME }}
  #         password: ${{ secrets.DOCKERHUB_TOKEN }}
  #     -
  #       name: Build and push
  #       uses: docker/build-push-action@v4
  #       with:
  #         push: true
  #         tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
  #         file: compose/local/django/Dockerfile

  deploy-ec2:
    runs-on: ubuntu-latest
    # needs: build-and-push-docker-image
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Execute Script
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa

      - name: Connect to EC2 and execute commands
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.USER_REMOTE }}@${{ secrets.IP_REMOTE }} "docker pull zethoc/devsof2-nrgx-backend && docker container run --rm -it --name devsof2 -p 8000:8000 --env-file .env -d zethoc/devsof2-nrgx-backend:latest && exit"
  
  # deploy-aws-ec2:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - id: deploy
  #       uses: bitovi/github-actions-deploy-docker-to-ec2@v0.5.0
  #       with:
  #         aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws_default_region: ${{ secrets.AWS_REGION }}
  #         dot_env: ${{ secrets.DOT_ENV }}

  # deploy-aws:
  #   runs-on: ubuntu-latest
  #   steps:

  #   - name: Checkout source code
  #     uses: actions/checkout@v2

  #   - name: Copy Dockerfile to application directory
  #     run: cp compose/local/django/Dockerfile .

  #   - name: Generate deployment package
  #     run: zip -r deploy.zip . -x '*.git*'

  #   - name: Deploy to EB
  #     uses: einaregilsson/beanstalk-deploy@v21
  #     with:
  #       aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #       aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #       application_name: devsoft-nrgx-backend
  #       environment_name: Devsoft-nrgx-backend-env
  #       version_label: ${{ github.sha }}
  #       region: ${{ secrets.AWS_REGION }}
  #       deployment_package: deploy.zip